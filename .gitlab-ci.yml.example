stages:
    - quality
    - deploy

frontend-check:
    stage: quality
    image: node:20
    before_script:
        - npm install -g pnpm
        - pnpm config set store-dir .pnpm-store
    script:
        - pnpm install --frozen-lockfile
        - pnpm run lint
    allow_failure: false
    cache:
        key:
            files:
                - pnpm-lock.yaml
        paths:
            - .pnpm-store
    rules:
        - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

backend-check:
    stage: quality
    image: composer:2
    before_script:
        - apk add --no-cache git zip unzip
    script:
        - composer install --prefer-dist --no-progress --ignore-platform-reqs --no-interaction
        - composer format
    allow_failure: false
    cache:
        key:
            files:
                - composer.lock
        paths:
            - vendor/
    rules:
        - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

deploy-vps:
    stage: deploy
    image: alpine:latest
    before_script:
        - apk add --no-cache openssh-client git
        - eval $(ssh-agent -s)
        - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
        - mkdir -p ~/.ssh
        - chmod 700 ~/.ssh
        - ssh-keyscan -p $VPS_PORT $VPS_IP >> ~/.ssh/known_hosts
        - chmod 644 ~/.ssh/known_hosts
    script:
        - ssh -p $VPS_PORT $VPS_USER@$VPS_IP "bash $DEPLOY_PATH/deploy.sh"
    rules:
        - if: $CI_COMMIT_BRANCH == "develop"


sonarqube-check:
    stage: quality
    image:
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: [""]
    variables:
        SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
        GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
    cache:
        key: "${CI_JOB_NAME}"
        paths:
            - .sonar/cache
    script:
        - sonar-scanner
    allow_failure: true
    rules:
        - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
        - if: $CI_COMMIT_BRANCH == "develop"
